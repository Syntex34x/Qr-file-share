<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroDrop | Diagnostic Mode</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #f1f5f9; font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, deleteDoc, doc, serverTimestamp } from "firebase/firestore";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "firebase/storage";

        // YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB23Xlx9wLi9ERHzw9sBYX2N6-XxckZiSc",
            authDomain: "qr-share-a3c86.firebaseapp.com",
            projectId: "qr-share-a3c86",
            storageBucket: "qr-share-a3c86.firebasestorage.app",
            messagingSenderId: "445728893026",
            appId: "1:445728893026:web:833ea25e39c537ea88893b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'qr-share-default';

        // --- Icons ---
        const Icon = ({ path }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>;
        const Icons = {
            Upload: <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Loading: <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
            Trash: <Icon path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />,
        };

        const App = () => {
            const [view, setView] = useState('landing');
            const [sessionId, setSessionId] = useState('');
            const [files, setFiles] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [status, setStatus] = useState('');

            // Auth Check
            useEffect(() => {
                setStatus('Connecting to Server...');
                signInAnonymously(auth)
                    .then(() => setStatus('Connected'))
                    .catch(err => {
                        console.error(err);
                        alert("Auth Error: " + err.message + "\nCheck if Authentication > Anonymous is enabled in Firebase Console.");
                        setStatus('Connection Failed');
                    });
            }, []);

            // URL Params
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const s = params.get('session');
                if (s) {
                    setSessionId(s);
                    setView('upload');
                }
            }, []);

            // File Sync
            useEffect(() => {
                if (!sessionId) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'files'), where('sessionId', '==', sessionId));
                return onSnapshot(q, (snap) => {
                    const f = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setFiles(f.sort((a,b) => b.createdAt - a.createdAt));
                }, (error) => {
                    // Alert if Database permissions are wrong
                    if (error.code === 'permission-denied') {
                        alert("DATABASE ERROR: Permission Denied.\nPlease go to Firebase Console > Firestore Database > Rules and change 'false' to 'true'.");
                    }
                });
            }, [sessionId]);

            const startSession = () => {
                const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setSessionId(newId);
                setView('session');
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setUploading(true);
                setStatus('Starting upload...');

                try {
                    // Upload to Storage
                    const storageRef = ref(storage, `uploads/${sessionId}/${Date.now()}_${file.name}`);
                    
                    setStatus('Uploading Bytes...');
                    // We added a catch block directly to the uploadBytes
                    const snapshot = await uploadBytes(storageRef, file).catch(error => {
                        throw new Error(`STORAGE ERROR: ${error.code} - ${error.message}`);
                    });

                    setStatus('Getting URL...');
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    setStatus('Saving to DB...');
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'files'), {
                        sessionId: sessionId,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: downloadURL,
                        storagePath: snapshot.ref.fullPath,
                        createdAt: serverTimestamp()
                    }).catch(error => {
                         throw new Error(`DB WRITE ERROR: ${error.code} - ${error.message}`);
                    });

                    setStatus('Success!');
                    setTimeout(() => setStatus('Connected'), 2000);

                } catch (error) {
                    console.error(error);
                    // THIS IS THE IMPORTANT PART:
                    alert("UPLOAD FAILED!\n\n" + error.message + "\n\nTip: Check Firebase Storage Rules.");
                    setStatus('Failed');
                } finally {
                    setUploading(false);
                    e.target.value = null;
                }
            };

            // Simple Views
            if (view === 'landing') return (
                <div className="h-screen flex flex-col items-center justify-center p-4">
                    <h1 className="text-4xl font-bold mb-8">AeroDrop Diag</h1>
                    <button onClick={startSession} className="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold">Start Session</button>
                    <div className="mt-4 text-sm text-slate-500">{status}</div>
                </div>
            );

            if (view === 'session') return (
                <div className="h-screen p-6 flex flex-col items-center">
                    <h2 className="text-2xl font-bold mb-4">Session: {sessionId}</h2>
                    <div className="bg-white p-4 rounded-xl shadow mb-8"><div ref={el => el && new QRCode(el, {text: window.location.href.split('?')[0] + '?session=' + sessionId})} /></div>
                    <div className="w-full max-w-md space-y-2">
                        {files.map(f => (
                            <div key={f.id} className="bg-white p-3 rounded shadow flex justify-between">
                                <a href={f.url} target="_blank" className="text-blue-600 underline truncate w-48">{f.name}</a>
                                <span className="text-xs text-slate-400">{(f.size/1024).toFixed(1)} KB</span>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (view === 'upload') return (
                <div className="h-screen p-6 flex flex-col">
                    <div className="mb-8 font-bold text-center">Connected to: {sessionId}</div>
                    
                    <label className={`flex-1 bg-white border-4 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center transition-all ${uploading ? 'opacity-50' : 'active:scale-95'}`}>
                        <input type="file" onChange={handleUpload} className="hidden" disabled={uploading} />
                        {uploading ? (
                            <>
                                <div className="animate-spin mb-4">{Icons.Loading}</div>
                                <div className="font-bold text-lg">{status}</div>
                            </>
                        ) : (
                            <>
                                <div className="text-blue-500 mb-4">{Icons.Upload}</div>
                                <div className="font-bold text-xl">Tap to Upload</div>
                                <div className="text-xs text-slate-400 mt-2">Diagnostic Mode</div>
                            </>
                        )}
                    </label>
                    <div className="mt-4 text-center text-xs text-red-500 font-mono break-all">{status.includes('Failed') ? 'Check Alert Box for Error' : ''}</div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
