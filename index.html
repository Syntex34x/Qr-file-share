<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroDrop | Fast File Share</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body { background-color: #f8fafc; overflow-x: hidden; }
        @media print { .no-print { display: none !important; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, deleteDoc, doc, serverTimestamp } from "firebase/firestore";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "firebase/storage";

        const firebaseConfig = {
            apiKey: "AIzaSyB23Xlx9wLi9ERHzw9sBYX2N6-XxckZiSc",
            authDomain: "qr-share-a3c86.firebaseapp.com",
            projectId: "qr-share-a3c86",
            storageBucket: "qr-share-a3c86.firebasestorage.app",
            messagingSenderId: "445728893026",
            appId: "1:445728893026:web:833ea25e39c537ea88893b"
        };

        let app, auth, db, storage, firebaseInitialized = false;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            firebaseInitialized = true;
        } catch (error) { console.error("Firebase init failed:", error); }

        const appId = 'qr-share-default';

        // --- Icons ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Zap: (p) => <Icon {...p} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            File: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />,
            Image: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />,
            Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Copy: (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />,
            Loading: (p) => <Icon {...p} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} className={`${p.className} animate-spin`} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
        };

        const formatSize = (bytes) => {
            if (bytes === 0) return '0 B';
            const k = 1024; const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        };

        // --- OPTIMIZED IMAGE COMPRESSION ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                // SKIP COMPRESSION for files under 3MB to speed up instant sharing
                if (file.size < 3 * 1024 * 1024) {
                    resolve(file);
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const maxDim = 1600; // Moderate resize
                        if (width > maxDim || height > maxDim) {
                            if (width > height) { height = (height / width) * maxDim; width = maxDim; }
                            else { width = (width / height) * maxDim; height = maxDim; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 0.7 quality is fast and good enough for sharing
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', 0.7);
                    };
                };
            });
        };

        const Background = () => (
            <div className="fixed inset-0 -z-10 overflow-hidden bg-slate-50">
                <div className="absolute top-0 left-1/4 w-96 h-96 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
                <div className="absolute top-0 right-1/4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
            </div>
        );

        const Button = ({ children, variant = 'primary', className, disabled, ...props }) => {
            const base = "px-6 py-3 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg",
                secondary: "bg-white text-slate-700 hover:bg-slate-50 border border-slate-200",
            };
            return <button className={`${base} ${variants[variant] || variants.primary} ${className}`} disabled={disabled} {...props}>{children}</button>;
        };

        const QRCode = ({ text }) => {
            const qrRef = useRef(null);
            useEffect(() => {
                if (qrRef.current && window.QRCode) {
                    qrRef.current.innerHTML = '';
                    new window.QRCode(qrRef.current, { text, width: 200, height: 200, colorDark: "#0f172a", correctLevel: window.QRCode.CorrectLevel.H });
                }
            }, [text]);
            return <div ref={qrRef} className="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 inline-block" />;
        };

        const App = () => {
            const [view, setView] = useState('landing');
            const [sessionId, setSessionId] = useState('');
            const [files, setFiles] = useState([]);
            const [searchId, setSearchId] = useState('');
            const [copied, setCopied] = useState(false);
            const [user, setUser] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
            const [authError, setAuthError] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState('connecting');

            useEffect(() => {
                if (!firebaseInitialized) {
                    setAuthError("Firebase failed."); setConnectionStatus('error'); return;
                }
                const attemptAuth = async () => {
                    try {
                        setConnectionStatus('connecting');
                        await signInAnonymously(auth);
                        setConnectionStatus('connected');
                    } catch (err) {
                        setAuthError("Connection failed. Check network.");
                        setConnectionStatus('error');
                    }
                };
                attemptAuth();
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) { setAuthError(null); setConnectionStatus('connected'); }
                });
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const s = params.get('session');
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (s) {
                    setSessionId(s);
                    setView(isMobile ? 'mobile-upload' : 'session');
                }
            }, []);

            useEffect(() => {
                if (!sessionId || !user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'files'), where('sessionId', '==', sessionId));
                return onSnapshot(q, (snap) => {
                    const f = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    f.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setFiles(f);
                });
            }, [sessionId, user]);

            const uploadUrl = useMemo(() => `${window.location.href.split('?')[0]}?session=${sessionId}`, [sessionId]);

            const startSession = () => {
                if (connectionStatus !== 'connected') return;
                setSessionId(Math.random().toString(36).substring(2, 8).toUpperCase());
                setFiles([]);
                setView('session');
            };

            const joinSession = (e) => {
                e.preventDefault();
                if (searchId.length > 3) {
                    setSessionId(searchId.toUpperCase());
                    setView(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'mobile-upload' : 'session');
                }
            };

            // --- OPTIMIZED UPLOAD HANDLER ---
            const handleUpload = async (e) => {
                if (!user || !sessionId) return;
                
                const filesToUpload = Array.from(e.target.files);
                if (filesToUpload.length === 0) return;

                const MAX_SIZE = 15 * 1024 * 1024;
                if (filesToUpload.some(f => f.size > MAX_SIZE)) {
                    alert("One or more files exceed 15MB limit.");
                    e.target.value = null;
                    return;
                }

                setUploading(true);
                let completed = 0;
                setUploadProgress({ current: 0, total: filesToUpload.length });

                try {
                    // PARALLEL UPLOAD: Fire all requests at once instead of batches
                    const promises = filesToUpload.map(async (file) => {
                        try {
                            let fileToUpload = file;
                            // Only compress if actually needed
                            if (file.type.startsWith('image/')) {
                                fileToUpload = await compressImage(file);
                            }

                            const timestamp = Date.now();
                            const rId = Math.random().toString(36).substring(2, 6);
                            const storageRef = ref(storage, `uploads/${sessionId}/${timestamp}_${rId}_${file.name}`);
                            
                            const snapshot = await uploadBytes(storageRef, fileToUpload);
                            const downloadURL = await getDownloadURL(snapshot.ref);

                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'files'), {
                                sessionId: sessionId,
                                name: file.name,
                                size: fileToUpload.size,
                                type: file.type,
                                url: downloadURL,
                                storagePath: snapshot.ref.fullPath,
                                createdAt: serverTimestamp()
                            });
                            
                            completed++;
                            setUploadProgress({ current: completed, total: filesToUpload.length });
                        } catch (err) {
                            console.error("Upload failed", err);
                        }
                    });

                    await Promise.all(promises);
                } catch (error) {
                    console.error("Upload error:", error);
                } finally {
                    setUploading(false);
                    setUploadProgress({ current: 0, total: 0 });
                    e.target.value = null;
                }
            };

            const removeFile = async (file) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'files', file.id));
                if (file.storagePath) deleteObject(ref(storage, file.storagePath)).catch(console.log);
            };

            const printFile = (url) => {
                const w = window.open(url);
                if (w) w.onload = () => w.print();
            };

            // --- VIEWS ---
            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <Background />
                    <div className="max-w-2xl animate-float">
                        <h1 className="text-5xl md:text-7xl font-bold text-slate-900 mb-6">AeroDrop <span className="text-blue-600">Fast.</span></h1>
                        <p className="text-xl text-slate-500 mb-8">Instant peer-to-peer file sharing & printing.</p>
                        <div className="flex flex-col sm:flex-row justify-center gap-4">
                            <Button onClick={startSession} disabled={connectionStatus !== 'connected'}>
                                {connectionStatus === 'connecting' ? 'Connecting...' : 'Start Session'} <Icons.ArrowRight className="w-5 h-5" />
                            </Button>
                            <form onSubmit={joinSession} className="relative">
                                <input type="text" placeholder="Session ID" value={searchId} onChange={e => setSearchId(e.target.value)}
                                    className="w-full h-14 pl-5 pr-12 rounded-xl border border-slate-200 focus:outline-none focus:border-blue-500" />
                                <button type="submit" className="absolute right-2 top-2 p-2 bg-slate-100 rounded-lg"><Icons.ArrowRight className="w-4 h-4" /></button>
                            </form>
                        </div>
                    </div>
                </div>
            );

            if (view === 'session') return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <div className="w-full md:w-[400px] bg-white border-r border-slate-200 p-8 flex flex-col no-print">
                        <button onClick={() => setView('landing')} className="flex items-center gap-2 text-slate-500 mb-6 font-bold"><Icons.Zap className="w-5 h-5" /> AeroDrop</button>
                        <div className="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-center mb-8">
                            <div className="flex justify-center mb-6"><QRCode text={uploadUrl} /></div>
                            <div className="flex items-center gap-2 bg-white p-2 rounded-lg border">
                                <span className="bg-slate-100 px-3 py-1 font-mono font-bold">{sessionId}</span>
                                <button onClick={() => { navigator.clipboard.writeText(uploadUrl); setCopied(true); setTimeout(() => setCopied(false), 2000); }} 
                                    className="flex-1 text-xs font-bold text-blue-600">{copied ? 'Copied' : 'Copy Link'}</button>
                            </div>
                        </div>
                        <div className="mt-auto text-sm text-slate-500 bg-green-50 text-green-700 p-4 rounded-xl flex gap-2 items-center">
                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live Sync Active
                        </div>
                    </div>
                    <div className="flex-1 p-8 overflow-y-auto">
                        <div className="max-w-5xl mx-auto">
                            <div className="flex justify-between items-end mb-8 no-print">
                                <h2 className="text-3xl font-bold">Files ({files.length})</h2>
                                {files.length > 0 && <Button onClick={() => files.forEach(f => printFile(f.url))} variant="secondary"><Icons.Printer className="w-4 h-4"/> Print All</Button>}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {files.map(file => (
                                    <div key={file.id} className="bg-white rounded-2xl shadow-sm border overflow-hidden hover:shadow-lg transition-all group">
                                        <div className="h-48 bg-slate-50 flex items-center justify-center relative">
                                            {file.type.includes('image') ? <img src={file.url} className="w-full h-full object-cover" /> : <Icons.File className="w-16 h-16 text-slate-300" />}
                                            <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                                <button onClick={() => printFile(file.url)} className="p-3 bg-white rounded-full hover:scale-110 transition-transform"><Icons.Printer className="w-5 h-5"/></button>
                                            </div>
                                        </div>
                                        <div className="p-4">
                                            <div className="flex justify-between mb-2">
                                                <h3 className="font-bold truncate w-32">{file.name}</h3>
                                                <button onClick={() => removeFile(file)} className="text-slate-300 hover:text-red-500"><Icons.Trash className="w-4 h-4"/></button>
                                            </div>
                                            <p className="text-xs text-slate-400">{formatSize(file.size)}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'mobile-upload') return (
                <div className="min-h-screen p-4 flex flex-col bg-slate-50">
                    <div className="bg-white p-4 rounded-xl mb-6 shadow-sm flex justify-between items-center">
                        <span className="font-bold flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span> {sessionId}</span>
                        <button onClick={() => setView('landing')} className="text-sm text-slate-400">Exit</button>
                    </div>
                    <label className={`flex-1 flex flex-col items-center justify-center border-4 border-dashed border-blue-200 rounded-[2rem] bg-white transition-all ${uploading ? 'opacity-50' : 'active:scale-95'}`}>
                        <input type="file" multiple onChange={handleUpload} className="hidden" disabled={uploading} accept="image/*,application/pdf" />
                        {uploading ? (
                            <div className="text-center">
                                <Icons.Loading className="w-12 h-12 text-blue-500 mb-4 mx-auto" />
                                <h3 className="text-xl font-bold">Uploading...</h3>
                                <p className="text-slate-500">{uploadProgress.current}/{uploadProgress.total}</p>
                            </div>
                        ) : (
                            <div className="text-center">
                                <div className="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500"><Icons.Upload className="w-8 h-8" /></div>
                                <h3 className="text-2xl font-bold text-slate-900">Tap to Upload</h3>
                            </div>
                        )}
                    </label>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
