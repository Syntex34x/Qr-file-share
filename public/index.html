<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroDrop | Local Share</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 'blob': 'blob 7s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        body { background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Auto-detect the API URL based on where the page is loaded from
        const API_URL = `${window.location.protocol}//${window.location.hostname}:3000/api`;

        const App = () => {
            const [view, setView] = useState('landing');
            const [sessionId, setSessionId] = useState('');
            const [files, setFiles] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [progress, setProgress] = useState(0);

            // Handle URL params for joining
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const s = params.get('session');
                if (s) {
                    setSessionId(s);
                    setView('mobile');
                }
            }, []);

            // Polling for new files (every 2 seconds)
            useEffect(() => {
                if (!sessionId || view === 'landing') return;

                const fetchFiles = async () => {
                    try {
                        const res = await fetch(`${API_URL}/files/${sessionId}`);
                        const data = await res.json();
                        setFiles(data);
                    } catch (err) {
                        console.error("Polling error:", err);
                    }
                };

                fetchFiles(); // Initial fetch
                const interval = setInterval(fetchFiles, 2000); // Poll every 2s
                return () => clearInterval(interval);
            }, [sessionId, view]);

            const startSession = () => {
                const newId = Math.random().toString(36).substring(2, 6).toUpperCase();
                setSessionId(newId);
                setView('desktop');
            };

            const handleUpload = async (e) => {
                const selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length === 0) return;

                setUploading(true);
                setProgress(0);

                let completed = 0;
                for (const file of selectedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('sessionId', sessionId);

                    try {
                        await fetch(`${API_URL}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        completed++;
                        setProgress(Math.round((completed / selectedFiles.length) * 100));
                    } catch (err) {
                        alert(`Failed to upload ${file.name}`);
                    }
                }

                setUploading(false);
                e.target.value = null; // Reset input
                alert("Upload Complete!");
            };

            const QRCodeComponent = ({ text }) => {
                const ref = useRef();
                useEffect(() => {
                    if (ref.current) {
                        ref.current.innerHTML = '';
                        new QRCode(ref.current, { text: text, width: 200, height: 200 });
                    }
                }, [text]);
                return <div ref={ref} className="bg-white p-4 rounded-xl shadow inline-block" />;
            };

            // --- Views ---

            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="fixed inset-0 -z-10 overflow-hidden bg-slate-50">
                        <div className="absolute top-0 left-1/4 w-96 h-96 bg-blue-300 rounded-full blur-3xl opacity-30 animate-blob"></div>
                    </div>
                    <h1 className="text-6xl font-bold text-slate-900 mb-6">AeroDrop <span className="text-blue-600">Local</span></h1>
                    <p className="text-xl text-slate-500 mb-8">Super fast file transfer over Wi-Fi.</p>
                    <button onClick={startSession} className="px-8 py-4 bg-slate-900 text-white rounded-xl font-bold text-lg hover:bg-slate-800 transition shadow-lg">
                        Start Session
                    </button>
                </div>
            );

            if (view === 'desktop') return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50">
                    {/* Sidebar */}
                    <div className="w-full md:w-96 bg-white border-r p-8 flex flex-col">
                        <button onClick={() => setView('landing')} className="text-slate-500 font-bold mb-8">‚Üê Back</button>
                        
                        <div className="bg-slate-100 p-6 rounded-2xl text-center mb-6">
                            <QRCodeComponent text={`${window.location.origin}/?session=${sessionId}`} />
                            <div className="mt-4 font-mono text-2xl font-bold tracking-widest">{sessionId}</div>
                            <p className="text-slate-500 text-sm mt-2">Scan with phone to connect</p>
                        </div>
                        
                        <div className="bg-green-100 text-green-800 p-4 rounded-xl text-sm font-medium flex items-center gap-2">
                            <span className="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                            Server Running: {window.location.hostname}
                        </div>
                    </div>

                    {/* File List */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        <h2 className="text-3xl font-bold text-slate-800 mb-6">Received Files ({files.length})</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {files.map(file => (
                                <a key={file.id} href={file.url} target="_blank" className="block group">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border hover:shadow-md transition-all flex items-center gap-4">
                                        <div className="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 font-bold text-xl">
                                            {file.type.includes('image') ? 'üñºÔ∏è' : 'üìÑ'}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="font-bold truncate text-slate-900">{file.name}</p>
                                            <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                        </div>
                                        <div className="opacity-0 group-hover:opacity-100 text-blue-600">‚¨áÔ∏è</div>
                                    </div>
                                </a>
                            ))}
                        </div>

                        {files.length === 0 && (
                            <div className="h-64 border-2 border-dashed border-slate-300 rounded-2xl flex items-center justify-center text-slate-400">
                                Waiting for uploads...
                            </div>
                        )}
                    </div>
                </div>
            );

            if (view === 'mobile') return (
                <div className="min-h-screen bg-slate-50 p-6 flex flex-col">
                    <div className="flex justify-between items-center mb-8">
                        <div className="font-bold text-slate-700 flex items-center gap-2">
                            <span className="w-3 h-3 bg-green-500 rounded-full"></span> {sessionId}
                        </div>
                        <button onClick={() => setView('landing')} className="text-sm text-slate-400">Exit</button>
                    </div>

                    <label className={`flex-1 bg-white border-4 border-dashed border-blue-200 rounded-[2rem] flex flex-col items-center justify-center shadow-sm transition-all ${uploading ? 'opacity-50 pointer-events-none' : 'active:scale-95'}`}>
                        <input type="file" multiple onChange={handleUpload} className="hidden" />
                        
                        {uploading ? (
                            <div className="text-center">
                                <div className="text-4xl mb-4 animate-bounce">üöÄ</div>
                                <h3 className="text-xl font-bold text-slate-800">Sending... {progress}%</h3>
                            </div>
                        ) : (
                            <div className="text-center p-8">
                                <div className="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">‚¨ÜÔ∏è</div>
                                <h3 className="text-2xl font-bold text-slate-900 mb-2">Tap to Upload</h3>
                                <p className="text-slate-500">Files save to computer instantly</p>
                            </div>
                        )}
                    </label>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>